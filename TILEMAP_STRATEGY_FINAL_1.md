# –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ —Å–ª–æ—è–º–∏ —Ç–∞–π–ª–º–∞–ø–∞

## Hybrid Predictive Layer Management System

> **–í–µ—Ä—Å–∏—è:** 1.0 FINAL
> **–î–∞—Ç–∞:** 2025-11-24
> **–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤ –∫ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏
> **–°–∏–Ω—Ç–µ–∑:** –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –ª—É—á—à–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –°—Ç—Ä–∞—Ç–µ–≥–∏–π 0, 1 –∏ 2

---

## Executive Summary

–î–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –≥–∏–±—Ä–∏–¥–Ω—É—é —Å–∏—Å—Ç–µ–º—É, –æ–±—ä–µ–¥–∏–Ω—è—é—â—É—é:

- ‚úÖ **Fast Path** (–∏–∑ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ 0) - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –≤ 80% —Å–ª—É—á–∞–µ–≤
- ‚úÖ **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã** (–∏–∑ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ 1) - –≥–∏–±–∫–æ—Å—Ç—å –∫ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –¥–≤–∏–∂–µ–Ω–∏—è
- ‚úÖ **–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏** (–∏–∑ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ 2) - –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
- ‚úÖ **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –æ–ø–µ—Ä–∞—Ü–∏–π** (–∏–∑ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ 2) - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- ‚úÖ **–ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** (—Å—Ç–∏–ª—å –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ 1) - –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é

**–ö–ª—é—á–µ–≤–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** –°–∏—Å—Ç–µ–º–∞ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –Ω–∞–≥—Ä—É–∑–∫–µ, –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –æ–±—ã—á–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö –∏ —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

---

## –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø—Ä–æ–±–ª–µ–º–∞

### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞:**

- `src/game/scenes/MainScene.ts` - –≥–ª–∞–≤–Ω–∞—è —Å—Ü–µ–Ω–∞ –∏–≥—Ä—ã
- `src/game/scenes/TilemapController.ts` - –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–π–ª–º–∞–ø–æ–º
- `src/game/constants.ts` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –¢—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–º–µ—Ä—ã**
   - –ù—É–∂–Ω–æ —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–º–µ–Ω—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª–æ—è
   - –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ `update()` –Ω–∞–≥—Ä—É–∂–∞—é—Ç —Ä–µ–Ω–¥–µ—Ä
   - –ú–∏–∫—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã —Å–æ–∑–¥–∞—é—Ç –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è

2. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—ë–≤**
   - –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—è –∑–∞–Ω–∏–º–∞–µ—Ç 100-300–º—Å (–¥–æ—Ä–æ–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è)
   - –í–æ–∑–º–æ–∂–Ω—ã race conditions –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –¥–≤–∏–∂–µ–Ω–∏—è –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ù–µ–æ–±—Ö–æ–¥–∏–º–∞ —Å–∏—Å—Ç–µ–º–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤

3. **–°–ª–æ–∂–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã**
   - –ü—Ä–∏–º–µ—Ä: –¥–≤–∏–∂–µ–Ω–∏–µ –≤–ª–µ–≤–æ ‚Üí –ø–æ–≤–æ—Ä–æ—Ç –≤–≤–µ—Ä—Ö ‚Üí –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
   - –¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏—é, –Ω–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
   - –°–æ–∑–¥–∞—é—Ç—Å—è –Ω–µ–Ω—É–∂–Ω—ã–µ —Å–ª–æ–∏, —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è

### –ê–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ—à–µ–Ω–∏–π

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Ç—Ä–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (—Å–º. `REVIEW_1.md`):

- **–°—Ç—Ä–∞—Ç–µ–≥–∏—è 0** (6.5/10) - –æ—Ç–ª–∏—á–Ω—ã–π fast path, –Ω–æ —Å–ª–∞–±–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è
- **–°—Ç—Ä–∞—Ç–µ–≥–∏—è 1** (8/10) - –±–∞–ª–∞–Ω—Å –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, –Ω–æ –æ—á–µ—Ä–µ–¥—å –º–∞–ª–∞
- **–°—Ç—Ä–∞—Ç–µ–≥–∏—è 2** (7.5/10) - —Ç–æ—á–Ω–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ, –Ω–æ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ä–µ–Ω–¥–µ—Ä

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           MainScene.update(time, delta)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –£–†–û–í–ï–ù–¨ 1: Fast Path Check (–∫–∞–∂–¥—ã–π –∫–∞–¥—Ä)          ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ         ‚îÇ
‚îÇ  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ Dynamic Safe Zone (O(1), ~0.001–º—Å)     ‚îÇ
‚îÇ  ‚Ä¢ –ï—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ ‚Üí –í–´–•–û–î (80% —Å–ª—É—á–∞–µ–≤)                ‚îÇ
‚îÇ  ‚Ä¢ –ï—Å–ª–∏ —Å–Ω–∞—Ä—É–∂–∏ ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –£—Ä–æ–≤–µ–Ω—å 2              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–Ω–µ Safe Zone)
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –£–†–û–í–ï–ù–¨ 2: Throttled Velocity Update (–∫–∞–∂–¥—ã–µ 3-5 –∫–∞–¥—Ä–æ–≤)‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ         ‚îÇ
‚îÇ  ‚Ä¢ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–≥–ª–∞–∂–µ–Ω–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ (EMA)            ‚îÇ
‚îÇ  ‚Ä¢ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –¥–≤–∏–∂–µ—Ç—Å—è / –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å             ‚îÇ
‚îÇ  ‚Ä¢ –ï—Å–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å ‚Üí –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è   ‚îÇ
‚îÇ  ‚Ä¢ –ï—Å–ª–∏ –¥–≤–∏–∂–µ—Ç—Å—è ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –£—Ä–æ–≤–µ–Ω—å 3             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–≤–∏–∂–µ—Ç—Å—è)
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –£–†–û–í–ï–ù–¨ 3: Predictive Analysis (–ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏)     ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ         ‚îÇ
‚îÇ  ‚Ä¢ –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ (—É—á—ë—Ç —É—Å–∫–æ—Ä–µ–Ω–∏—è)        ‚îÇ
‚îÇ  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü                       ‚îÇ
‚îÇ  ‚Ä¢ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ—è          ‚îÇ
‚îÇ  ‚Ä¢ –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Üí –∑–∞–ø—Ä–æ—Å –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –£–†–û–í–ï–ù–¨ 4: Operation Queue (async)                ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ         ‚îÇ
‚îÇ  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (isGenerating)               ‚îÇ
‚îÇ  ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥—å—é —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏               ‚îÇ
‚îÇ  ‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (async)                      ‚îÇ
‚îÇ  ‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª–µ–¥—É—é—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. Dynamic Safe Zone (–£—Ä–æ–≤–µ–Ω—å 1)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –≤ —Ç–∏–ø–∏—á–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö —á–µ—Ä–µ–∑ –¥–µ—à—ë–≤—É—é –ø—Ä–æ–≤–µ—Ä–∫—É.

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**

- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –≤ —Ü–µ–Ω—Ç—Ä–µ —Å–ª–æ—è
- –ë–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä: 40% –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —Å–ª–æ—è
- –†–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∫–æ—Ä–æ—Å—Ç–∏

**–ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã—á–∏—Å–ª–µ–Ω–∏—è:**

```typescript
private updateDynamicSafeZone(): void {
  const layer = this.getActiveLayer();
  const bounds = layer.getBounds();

  // –ë–∞–∑–æ–≤–∞—è –∑–æ–Ω–∞ (40% –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —Å–ª–æ—è)
  const baseWidth = bounds.width * 0.4;
  const baseHeight = bounds.height * 0.4;
  const baseCenterX = bounds.centerX;
  const baseCenterY = bounds.centerY;

  // –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
  const speed = Math.sqrt(this.velocity.x ** 2 + this.velocity.y ** 2);
  const lookaheadTime = 200; // –º—Å

  if (speed > this.STOP_THRESHOLD) {
    // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    const dirX = this.velocity.x / speed;
    const dirY = this.velocity.y / speed;

    // –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∑–æ–Ω—ã –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è
    const expansion = speed * lookaheadTime;
    const offsetX = dirX * expansion;
    const offsetY = dirY * expansion;

    this.dynamicSafeZone.setTo(
      baseCenterX + offsetX - baseWidth / 2,
      baseCenterY + offsetY - baseHeight / 2,
      baseWidth,
      baseHeight
    );
  } else {
    // –ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ - –±–∞–∑–æ–≤–∞—è –∑–æ–Ω–∞
    this.dynamicSafeZone.setTo(
      baseCenterX - baseWidth / 2,
      baseCenterY - baseHeight / 2,
      baseWidth,
      baseHeight
    );
  }
}

private isInSafeZone(): boolean {
  const { centerX, centerY } = this.scene.cameras.main;
  return this.dynamicSafeZone.contains(centerX, centerY);
}
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `BASE_SAFE_ZONE_RATIO = 0.4` - –±–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –∑–æ–Ω—ã (40%)
- `LOOKAHEAD_TIME = 200` - –≤—Ä–µ–º—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∑–æ–Ω—ã (–º—Å)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- ‚úÖ O(1) —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (~0.001–º—Å)
- ‚úÖ –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–≤–∏–∂–µ–Ω–∏—è
- ‚úÖ 80% –≤—Ä–µ–º–µ–Ω–∏ –≤—ã—Ö–æ–¥–∏—Ç —Å—Ä–∞–∑—É (fast path)

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**

- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–Ω–æ —Ä–µ–¥–∫–æ)

---

### 2. Throttled Velocity Tracking (–£—Ä–æ–≤–µ–Ω—å 2)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –±–µ–∑ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä.

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**

- –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ä–∞–∑ –≤ N –∫–∞–¥—Ä–æ–≤ (throttling)
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ (EMA)
- –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∫–æ—Ä–æ—Å—Ç–∏

**–ê–ª–≥–æ—Ä–∏—Ç–º:**

```typescript
private frameCounter = 0;
private velocity = { x: 0, y: 0 };
private acceleration = { x: 0, y: 0 };
private lastPosition = { x: 0, y: 0 };
private lastVelocity = { x: 0, y: 0 };
private lastUpdateTime = 0;

private getThrottleInterval(): number {
  const speed = Math.sqrt(this.velocity.x ** 2 + this.velocity.y ** 2);

  // –ë—ã—Å—Ç—Ä–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ - —á–∞—â–µ –æ–±–Ω–æ–≤–ª—è–µ–º
  if (speed > 1.5) return 2;  // –∫–∞–∂–¥—ã–µ 2 –∫–∞–¥—Ä–∞
  // –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ - —Ä–µ–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º
  if (speed > 0.5) return 3;  // –∫–∞–∂–¥—ã–µ 3 –∫–∞–¥—Ä–∞
  // –ü–æ—á—Ç–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ - —Ä–µ–¥–∫–æ –æ–±–Ω–æ–≤–ª—è–µ–º
  return 5; // –∫–∞–∂–¥—ã–µ 5 –∫–∞–¥—Ä–æ–≤
}

updateVelocityThrottled(): void {
  this.frameCounter++;

  const throttleInterval = this.getThrottleInterval();
  if (this.frameCounter % throttleInterval !== 0) {
    return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–∞–¥—Ä
  }

  const now = performance.now();
  const deltaTime = now - this.lastUpdateTime;

  // –ó–∞—â–∏—Ç–∞ –æ—Ç –∞–Ω–æ–º–∞–ª–∏–π
  if (deltaTime < 1 || deltaTime > 1000) return;

  const { centerX, centerY } = this.scene.cameras.main;

  // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏
  if (!isFinite(centerX) || !isFinite(centerY)) return;

  // –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
  const instantVelocityX = (centerX - this.lastPosition.x) / deltaTime;
  const instantVelocityY = (centerY - this.lastPosition.y) / deltaTime;

  // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ (EMA)
  const alpha = this.VELOCITY_SMOOTHING;
  const newVelocityX = this.velocity.x * alpha + instantVelocityX * (1 - alpha);
  const newVelocityY = this.velocity.y * alpha + instantVelocityY * (1 - alpha);

  // –£—Å–∫–æ—Ä–µ–Ω–∏–µ (–¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è)
  this.acceleration.x = (newVelocityX - this.velocity.x) / deltaTime;
  this.acceleration.y = (newVelocityY - this.velocity.y) / deltaTime;

  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
  const MAX_SPEED = 10; // px/ms
  this.velocity.x = Math.max(-MAX_SPEED, Math.min(MAX_SPEED, newVelocityX));
  this.velocity.y = Math.max(-MAX_SPEED, Math.min(MAX_SPEED, newVelocityY));

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  this.lastPosition = { x: centerX, y: centerY };
  this.lastVelocity = { x: this.velocity.x, y: this.velocity.y };
  this.lastUpdateTime = now;

  // –û–±–Ω–æ–≤–ª—è–µ–º Safe Zone –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏
  this.updateDynamicSafeZone();
}

isCameraStopped(): boolean {
  const speed = Math.sqrt(this.velocity.x ** 2 + this.velocity.y ** 2);
  return speed < this.STOP_THRESHOLD;
}
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `VELOCITY_SMOOTHING = 0.7` - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
- `STOP_THRESHOLD = 0.5` - –ø–æ—Ä–æ–≥ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (px/ms)
- `MAX_SPEED = 10` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (px/ms)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π throttling —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É
- ‚úÖ –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –¥—Ä–æ–∂–∞–Ω–∏–µ
- ‚úÖ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —É—Å–∫–æ—Ä–µ–Ω–∏—è –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –∞–Ω–æ–º–∞–ª–∏–π (NaN, Infinity, lag spikes)

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**

- ‚ö†Ô∏è –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏

---

### 3. Predictive Trajectory Analysis (–£—Ä–æ–≤–µ–Ω—å 3)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∫–∞–º–µ—Ä—ã –∏ –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—ë–≤.

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**

- –ö–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞—è —ç–∫—Å—Ç—Ä–∞–ø–æ–ª—è—Ü–∏—è —Å —É—á—ë—Ç–æ–º —É—Å–∫–æ—Ä–µ–Ω–∏—è
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –≤—ã—Ö–æ–¥ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã

**–ê–ª–≥–æ—Ä–∏—Ç–º:**

```typescript
private predictCameraPosition(timeAheadMs: number): { x: number, y: number } {
  const { centerX, centerY } = this.scene.cameras.main;
  const t = timeAheadMs / 1000; // —Å–µ–∫—É–Ω–¥—ã

  // –ö–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞—è —ç–∫—Å—Ç—Ä–∞–ø–æ–ª—è—Ü–∏—è: pos = pos‚ÇÄ + v*t + 0.5*a*t¬≤
  const predictedX = centerX + this.velocity.x * t * 1000 + 0.5 * this.acceleration.x * (t * 1000) ** 2;
  const predictedY = centerY + this.velocity.y * t * 1000 + 0.5 * this.acceleration.y * (t * 1000) ** 2;

  return { x: predictedX, y: predictedY };
}

private shouldCreateNewLayer(): { direction: { x: -1 | 0 | 1, y: -1 | 0 | 1 }, reason: string } | null {
  if (this.isCameraStopped()) return null;

  // –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —á–µ—Ä–µ–∑ 300–º—Å
  const predicted = this.predictCameraPosition(300);

  const layer = this.getActiveLayer();
  const predictedTile = layer.worldToTileXY(predicted.x, predicted.y);

  // –ö–∞–º–µ—Ä–∞ –≤—ã–π–¥–µ—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Å–ª–æ—è
  if (!predictedTile) {
    const bounds = layer.getBounds();
    return {
      direction: {
        x: predicted.x < bounds.left ? -1 : predicted.x > bounds.right ? 1 : 0,
        y: predicted.y < bounds.top ? -1 : predicted.y > bounds.bottom ? 1 : 0,
      },
      reason: 'predicted_out_of_bounds',
    };
  }

  // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è
  const speed = Math.sqrt(this.velocity.x ** 2 + this.velocity.y ** 2);
  const dirX = this.velocity.x / speed;
  const dirY = this.velocity.y / speed;

  const { width: widthTiles, height: heightTiles } = this.tilemap;

  // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã
  const baseThreshold = 0.33; // 33% –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
  const aggressiveThreshold = 0.50; // 50% –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  const isHorizontalDominant = Math.abs(dirX) > Math.abs(dirY) * 1.2;
  const isVerticalDominant = Math.abs(dirY) > Math.abs(dirX) * 1.2;

  let needsUpdate = false;
  let direction = { x: 0 as -1 | 0 | 1, y: 0 as -1 | 0 | 1 };

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü
  if (Math.abs(dirX) > 0.1) {
    const threshold = isHorizontalDominant ? aggressiveThreshold : baseThreshold;
    const edgeTiles = Math.round(widthTiles * threshold);

    if (dirX < 0 && predictedTile.x < edgeTiles) {
      needsUpdate = true;
      direction.x = -1;
    } else if (dirX > 0 && predictedTile.x > widthTiles - edgeTiles) {
      needsUpdate = true;
      direction.x = 1;
    }
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü
  if (Math.abs(dirY) > 0.1) {
    const threshold = isVerticalDominant ? aggressiveThreshold : baseThreshold;
    const edgeTiles = Math.round(heightTiles * threshold);

    if (dirY < 0 && predictedTile.y < edgeTiles) {
      needsUpdate = true;
      direction.y = -1;
    } else if (dirY > 0 && predictedTile.y > heightTiles - edgeTiles) {
      needsUpdate = true;
      direction.y = 1;
    }
  }

  if (needsUpdate) {
    return {
      direction,
      reason: `adaptive_boundary_${isHorizontalDominant ? 'horizontal' : isVerticalDominant ? 'vertical' : 'diagonal'}`,
    };
  }

  return null;
}
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `PREDICTION_TIME = 300` - –≤—Ä–µ–º—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è (–º—Å)
- `BASE_THRESHOLD = 0.33` - –±–∞–∑–æ–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ (33%)
- `AGGRESSIVE_THRESHOLD = 0.50` - –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ (50%)
- `DIRECTION_DOMINANCE_RATIO = 1.2` - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–æ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Å–∏

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- ‚úÖ –ö–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞—è —ç–∫—Å—Ç—Ä–∞–ø–æ–ª—è—Ü–∏—è —É—á–∏—Ç—ã–≤–∞–µ—Ç —É—Å–∫–æ—Ä–µ–Ω–∏–µ
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫–æ–Ω–æ–º—è—Ç —Ä–µ—Å—É—Ä—Å—ã
- ‚úÖ –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫–∏
- ‚úÖ –†–∞–∑–ª–∏—á–∞–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ/–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ/–¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**

- ‚ö†Ô∏è –°–ª–æ–∂–Ω–µ–µ –≤ –æ—Ç–ª–∞–¥–∫–µ
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

---

### 4. Priority Operation Queue (–£—Ä–æ–≤–µ–Ω—å 4)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ race conditions –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ –æ–ø–µ—Ä–∞—Ü–∏–π.

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**

- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ (—Ä–∞–∑–º–µ—Ä 3)
- –î–≤–∏–∂–µ–Ω–∏–µ –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- Async –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:**

```typescript
interface LayerOperation {
  type: 'movement' | 'center';
  priority: number;
  direction?: { x: -1 | 0 | 1, y: -1 | 0 | 1 };
  timestamp: number;
  reason?: string;
}

private isLayerGenerating = false;
private operationQueue: LayerOperation[] = [];
private readonly MAX_QUEUE_SIZE = 3;
private readonly PRIORITY = {
  MOVEMENT: 10,
  CENTER: 1,
} as const;
```

**–ê–ª–≥–æ—Ä–∏—Ç–º:**

```typescript
requestLayerOperation(type: 'movement' | 'center', direction?: { x: -1 | 0 | 1, y: -1 | 0 | 1 }, reason?: string): void {
  const priority = type === 'movement' ? this.PRIORITY.MOVEMENT : this.PRIORITY.CENTER;

  const operation: LayerOperation = {
    type,
    priority,
    direction,
    timestamp: performance.now(),
    reason,
  };

  // –ï—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è —Å –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º, —É–¥–∞–ª—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –Ω–∏–∑–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
  if (priority === this.PRIORITY.MOVEMENT) {
    this.operationQueue = this.operationQueue.filter(op => op.priority >= this.PRIORITY.MOVEMENT);
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é
  this.operationQueue.push(operation);

  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (—É–±—ã–≤–∞–Ω–∏–µ)
  this.operationQueue.sort((a, b) => b.priority - a.priority);

  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏
  if (this.operationQueue.length > this.MAX_QUEUE_SIZE) {
    this.operationQueue = this.operationQueue.slice(0, this.MAX_QUEUE_SIZE);
  }

  // –ú–µ—Ç—Ä–∏–∫–∏
  this.metrics.queueOperations++;

  // –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å
  this.processOperationQueue();
}

private async processOperationQueue(): Promise<void> {
  // –£–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–ø–µ—Ä–∞—Ü–∏—è
  if (this.isLayerGenerating) return;

  // –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞
  if (this.operationQueue.length === 0) return;

  // –ë–µ—Ä—ë–º –æ–ø–µ—Ä–∞—Ü–∏—é —Å –Ω–∞–∏–≤—ã—Å—à–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
  const operation = this.operationQueue.shift()!;

  this.isLayerGenerating = true;
  const startTime = performance.now();

  try {
    if (operation.type === 'center') {
      await this.centerLayerOnCameraAsync();
      this.metrics.centerOperations++;
    } else {
      await this.reloadLayerOnCameraShiftAsync(operation.direction!);
      this.metrics.movementOperations++;
    }

    const generationTime = performance.now() - startTime;
    this.setAvgTileGenTime(generationTime);

    // –ú–µ—Ç—Ä–∏–∫–∏
    this.metrics.totalOperations++;
    this.metrics.lastOperationTime = generationTime;

  } catch (error) {
    console.error('Layer generation failed:', error);
    this.metrics.failedOperations++;
  } finally {
    this.isLayerGenerating = false;

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –æ–ø–µ—Ä–∞—Ü–∏—é
    if (this.operationQueue.length > 0) {
      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
      await new Promise(resolve => setTimeout(resolve, 16));
      this.processOperationQueue();
    }
  }
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π UX
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —É—Ç–µ—á–∫—É –ø–∞–º—è—Ç–∏
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**

- ‚ö†Ô∏è –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –Ω–∏–∑–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –º–æ–≥—É—Ç –æ—Ç–º–µ–Ω—è—Ç—å—Å—è

---

### 5. Debounced Center on Stop

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ä–µ–∞–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–º–µ—Ä—ã.

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**

- Phaser Timer –≤–º–µ—Å—Ç–æ setTimeout
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–º–µ–Ω–∞ –ø—Ä–∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º

**–ê–ª–≥–æ—Ä–∏—Ç–º:**

```typescript
private centerDebounceTimer?: Phaser.Time.TimerEvent;
private readonly CENTER_DEBOUNCE_DELAY = 600; // –º—Å

scheduleCenterOnStop(): void {
  // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
  if (this.centerDebounceTimer) {
    this.centerDebounceTimer.destroy();
    this.centerDebounceTimer = undefined;
  }

  // –ü–ª–∞–Ω–∏—Ä—É–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É
  this.centerDebounceTimer = this.scene.time.delayedCall(
    this.CENTER_DEBOUNCE_DELAY,
    () => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞–º–µ—Ä–∞ –≤—Å—ë –µ—â—ë –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
      if (this.isCameraStopped()) {
        this.requestLayerOperation('center', undefined, 'camera_stopped');
      }
      this.centerDebounceTimer = undefined;
    }
  );
}

cancelCenterDebounce(): void {
  if (this.centerDebounceTimer) {
    this.centerDebounceTimer.destroy();
    this.centerDebounceTimer = undefined;
  }
}
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `CENTER_DEBOUNCE_DELAY = 600` - –∑–∞–¥–µ—Ä–∂–∫–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è (–º—Å)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- ‚úÖ Phaser Timer —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –∏–≥—Ä–æ–≤—ã–º —Ü–∏–∫–ª–æ–º
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ —Å—Ü–µ–Ω—ã
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–Ω—É–∂–Ω—ã–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è

---

## –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```typescript
// –í MainScene.update()
update(time: number, delta: number): void {
  super.update(time, delta);

  // –î–µ–ª–µ–≥–∏—Ä—É–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ—è–º–∏ TilemapController
  this.tilemapController.updateLayerManagement();

  // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
}

// –í TilemapController
updateLayerManagement(): void {
  // –£–†–û–í–ï–ù–¨ 1: Fast Path Check (–∫–∞–∂–¥—ã–π –∫–∞–¥—Ä)
  if (this.isInSafeZone()) {
    return; // 80% —Å–ª—É—á–∞–µ–≤ –≤—ã—Ö–æ–¥–∏–º –∑–¥–µ—Å—å
  }

  // –£–†–û–í–ï–ù–¨ 2: Throttled Velocity Update (–∫–∞–∂–¥—ã–µ N –∫–∞–¥—Ä–æ–≤)
  this.updateVelocityThrottled();

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É
  if (this.isCameraStopped()) {
    // –ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å - –ø–ª–∞–Ω–∏—Ä—É–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
    if (!this.centerDebounceTimer) {
      this.scheduleCenterOnStop();
    }
    return;
  }

  // –ö–∞–º–µ—Ä–∞ –¥–≤–∏–∂–µ—Ç—Å—è - –æ—Ç–º–µ–Ω—è–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
  this.cancelCenterDebounce();

  // –£–†–û–í–ï–ù–¨ 3: Predictive Analysis (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏)
  const prediction = this.shouldCreateNewLayer();

  if (prediction) {
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—è
    this.requestLayerOperation('movement', prediction.direction, prediction.reason);
  }

  // –£–†–û–í–ï–ù–¨ 4: Operation Queue –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
}
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞

### –ù–æ–≤—ã–µ –ø–æ–ª—è TilemapController

```typescript
export class TilemapController {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...

  // –£—Ä–æ–≤–µ–Ω—å 1: Dynamic Safe Zone
  private dynamicSafeZone: Phaser.Geom.Rectangle;

  // –£—Ä–æ–≤–µ–Ω—å 2: Velocity Tracking
  private frameCounter = 0;
  private velocity = { x: 0, y: 0 };
  private acceleration = { x: 0, y: 0 };
  private lastPosition = { x: 0, y: 0 };
  private lastVelocity = { x: 0, y: 0 };
  private lastUpdateTime = 0;

  // –£—Ä–æ–≤–µ–Ω—å 3: Prediction
  // (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç velocity –∏ acceleration)

  // –£—Ä–æ–≤–µ–Ω—å 4: Operation Queue
  private isLayerGenerating = false;
  private operationQueue: LayerOperation[] = [];

  // –£—Ä–æ–≤–µ–Ω—å 5: Debounce
  private centerDebounceTimer?: Phaser.Time.TimerEvent;

  // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
  private readonly BASE_SAFE_ZONE_RATIO = 0.4;
  private readonly LOOKAHEAD_TIME = 200; // –º—Å
  private readonly VELOCITY_SMOOTHING = 0.7;
  private readonly STOP_THRESHOLD = 0.5; // px/ms
  private readonly MAX_SPEED = 10; // px/ms
  private readonly PREDICTION_TIME = 300; // –º—Å
  private readonly BASE_THRESHOLD = 0.33;
  private readonly AGGRESSIVE_THRESHOLD = 0.50;
  private readonly DIRECTION_DOMINANCE_RATIO = 1.2;
  private readonly MAX_QUEUE_SIZE = 3;
  private readonly CENTER_DEBOUNCE_DELAY = 600; // –º—Å
  private readonly PRIORITY = {
    MOVEMENT: 10,
    CENTER: 1,
  } as const;

  // –ú–µ—Ç—Ä–∏–∫–∏
  private metrics = {
    totalOperations: 0,
    movementOperations: 0,
    centerOperations: 0,
    failedOperations: 0,
    queueOperations: 0,
    lastOperationTime: 0,
    fastPathHits: 0,
  };
}
```

### –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã

```typescript
// –£—Ä–æ–≤–µ–Ω—å 1
private updateDynamicSafeZone(): void
private isInSafeZone(): boolean

// –£—Ä–æ–≤–µ–Ω—å 2
private getThrottleInterval(): number
private updateVelocityThrottled(): void
private isCameraStopped(): boolean

// –£—Ä–æ–≤–µ–Ω—å 3
private predictCameraPosition(timeAheadMs: number): { x: number, y: number }
private shouldCreateNewLayer(): { direction: {...}, reason: string } | null

// –£—Ä–æ–≤–µ–Ω—å 4
private requestLayerOperation(type, direction?, reason?): void
private async processOperationQueue(): Promise<void>

// –£—Ä–æ–≤–µ–Ω—å 5
private scheduleCenterOnStop(): void
private cancelCenterDebounce(): void

// –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥
public updateLayerManagement(): void

// –£—Ç–∏–ª–∏—Ç—ã
public getMetrics(): typeof this.metrics
public destroy(): void
```

### –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–µ—Ç–æ–¥–æ–≤

```typescript
// –°–¥–µ–ª–∞—Ç—å async
private async centerLayerOnCameraAsync(): Promise<void>
private async reloadLayerOnCameraShiftAsync(direction: { x, y }): Promise<void>
private async updateLayerAsync(...): Promise<void>

// –£–î–ê–õ–ò–¢–¨ (–∑–∞–º–µ–Ω–µ–Ω—ã –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π)
// - checkCameraPosition() ‚Üí –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ shouldCreateNewLayer()
// - getAvgTileGenTime() ‚Üí –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ MainScene
```

---

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ MainScene

### –í –º–µ—Ç–æ–¥–µ create()

```typescript
create() {
  this.tilemapController = new TilemapController(this);
  // TilemapController —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–Ω–æ–º–µ–Ω

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥—Ä—É–≥–∏—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤
  this.cameraMoveController = new CameraMoveController({ camera, input });
  this.zoomController = new CameraZoomController({ camera, input, saveCameraPosition });
  this.tileController = new TileController({ camera, input, gridRenderer: this.tilemapController });

  if (input.keyboard) registerUIKeyboardBindings(input.keyboard);
}
```

**–£–î–ê–õ–ò–¢–¨:**

```typescript
// –í–µ—Å—å –±–ª–æ–∫ —Å tilemapStreamingTimer
private tilemapStreamingTimer?: Time.TimerEvent;

this.tilemapStreamingTimer = this.time.addEvent({...});
```

### –í –º–µ—Ç–æ–¥–µ update()

```typescript
update(time: number, delta: number) {
  super.update(time, delta);

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ—è–º–∏ - –æ–¥–∏–Ω –≤—ã–∑–æ–≤
  this.tilemapController.updateLayerManagement();

  // –î–≤–∏–∂–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
  this.cameraMoveController.handleMovement(delta);

  // –†–µ–Ω–¥–µ—Ä —Å–µ—Ç–∫–∏
  const { main: camera } = this.cameras;
  const uiStore = useUIStore();
  this.tilemapController.renderGrid(camera, uiStore.showGrid);
}
```

### –í –º–µ—Ç–æ–¥–µ destroy() (–¥–æ–±–∞–≤–∏—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç)

```typescript
destroy() {
  this.tilemapController?.destroy();
  super.destroy();
}
```

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–í `src/game/constants.ts` –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

```typescript
export const TILEMAP_LAYER_CONFIG = {
  // Safe Zone
  baseSafeZoneRatio: 0.4,
  lookaheadTime: 200,

  // Velocity
  velocitySmoothing: 0.7,
  stopThreshold: 0.5,
  maxSpeed: 10,

  // Prediction
  predictionTime: 300,
  baseThreshold: 0.33,
  aggressiveThreshold: 0.50,
  directionDominanceRatio: 1.2,

  // Queue
  maxQueueSize: 3,
  priorityMovement: 10,
  priorityCenter: 1,

  // Debounce
  centerDebounceDelay: 600,
} as const;
```

---

## –ê–Ω–∞–ª–∏–∑ —Ä–µ—à–µ–Ω–∏—è

### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**
   - Fast Path –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 80% —Å–ª—É—á–∞–µ–≤ –∑–∞ ~0.001–º—Å
   - –°–ª–æ–∂–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
   - –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π throttling —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É

2. **–¢–æ—á–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å**
   - –ö–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞—è —ç–∫—Å—Ç—Ä–∞–ø–æ–ª—è—Ü–∏—è —É—á–∏—Ç—ã–≤–∞–µ—Ç —É—Å–∫–æ—Ä–µ–Ω–∏–µ
   - –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫–æ–Ω–æ–º—è—Ç —Ä–µ—Å—É—Ä—Å—ã
   - –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ EMA —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –¥—Ä–æ–∂–∞–Ω–∏–µ

3. **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å**
   - –ì–∞—Ä–∞–Ω—Ç–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è race conditions
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ UX
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases (NaN, Infinity, lag)

4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –≤ —Ç–∏–ø–∏—á–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö
   - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏
   - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

5. **Maintainability**
   - –ß—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–∏
   - –•–æ—Ä–æ—à–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
   - –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

6. **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å**
   - –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ async –æ–ø–µ—Ä–∞—Ü–∏—è–º
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
   - –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### ‚ö†Ô∏è –ö–æ–º–ø—Ä–æ–º–∏—Å—Å—ã

1. **–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**
   - –ë–æ–ª—å—à–µ –∫–æ–¥–∞, —á–µ–º –≤ –ø—Ä–æ—Å—Ç—ã—Ö —Ä–µ—à–µ–Ω–∏—è—Ö
   - –¢—Ä–µ–±—É–µ—Ç –ø–æ–Ω–∏–º–∞–Ω–∏—è –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –•–æ—Ä–æ—à–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –º–æ–¥—É–ª—å–Ω–æ—Å—Ç—å

2. **–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**
   - –ú–Ω–æ–≥–æ –∫–æ–Ω—Å—Ç–∞–Ω—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
   - –í–∑–∞–∏–º–æ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –•–æ—Ä–æ—à–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

3. **–û—Ç–ª–∞–¥–∫–∞**
   - –ë–æ–ª—å—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –°–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

4. **–ü–∞–º—è—Ç—å**
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
   - **–û—Ü–µ–Ω–∫–∞:** +~1KB (–Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ)

### üîç –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∏—Å—Ö–æ–¥–Ω—ã–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏

| –ö—Ä–∏—Ç–µ—Ä–∏–π                           | –°—Ç—Ä.0  | –°—Ç—Ä.1 | –°—Ç—Ä.2  | FINAL      |
| ---------------------------------- | ------ | ----- | ------ | ---------- |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (fast path)** | 9/10   | 6/10  | 6/10   | **10/10**  |
| **–¢–æ—á–Ω–æ—Å—Ç—å –¥–µ—Ç–µ–∫—Ü–∏–∏**              | 4/10   | 7/10  | 9/10   | **9/10**   |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª–æ–∂–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è**    | 3/10   | 9/10  | 10/10  | **10/10**  |
| **–ó–∞—â–∏—Ç–∞ –æ—Ç race conditions**      | 5/10   | 7/10  | 9/10   | **10/10**  |
| **–ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**            | 7/10   | 5/10  | 4/10   | **5/10**   |
| **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**                   | 5/10   | 10/10 | 8/10   | **10/10**  |
| **–ò–¢–û–ì–û**                          | 6.5/10 | 8/10  | 7.5/10 | **9.2/10** |

---

## –ü–ª–∞–Ω –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (2-3 —á–∞—Å–∞)

**–ó–∞–¥–∞—á–∏:**

1. ‚úÖ –ò–∑—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
3. ‚¨ú –°–æ–∑–¥–∞—Ç—å –∫–æ–º–º–∏—Ç/–±—ç–∫–∞–ø
4. ‚¨ú –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è –≤ TilemapController
5. ‚¨ú –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ —Ç–∏–ø—ã

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –ö–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

### –≠—Ç–∞–ø 2: –£—Ä–æ–≤–µ–Ω—å 1 - Fast Path (1 —á–∞—Å)

**–ó–∞–¥–∞—á–∏:**

1. ‚¨ú –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `updateDynamicSafeZone()`
2. ‚¨ú –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `isInSafeZone()`
3. ‚¨ú –î–æ–±–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—ã–π `updateLayerManagement()` —Å Fast Path
4. ‚¨ú –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `MainScene.update()`
5. ‚¨ú –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Fast Path

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** Fast Path —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤—ã—Ö–æ–¥–∏—Ç –ø—Ä–∏ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–∏ –≤ –∑–æ–Ω–µ

### –≠—Ç–∞–ø 3: –£—Ä–æ–≤–µ–Ω—å 2 - Velocity Tracking (2 —á–∞—Å–∞)

**–ó–∞–¥–∞—á–∏:**

1. ‚¨ú –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `getThrottleInterval()`
2. ‚¨ú –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `updateVelocityThrottled()`
3. ‚¨ú –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `isCameraStopped()`
4. ‚¨ú –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `updateLayerManagement()`
5. ‚¨ú –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–µ–∫—Ü–∏—é –¥–≤–∏–∂–µ–Ω–∏—è/–æ—Å—Ç–∞–Ω–æ–≤–∫–∏

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –°–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫—É

### –≠—Ç–∞–ø 4: –£—Ä–æ–≤–µ–Ω—å 3 - Prediction (2-3 —á–∞—Å–∞)

**–ó–∞–¥–∞—á–∏:**

1. ‚¨ú –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `predictCameraPosition()`
2. ‚¨ú –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `shouldCreateNewLayer()`
3. ‚¨ú –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `updateLayerManagement()`
4. ‚¨ú –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –°–ª–æ–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –∫ –≥—Ä–∞–Ω–∏—Ü–∞–º

### –≠—Ç–∞–ø 5: –£—Ä–æ–≤–µ–Ω—å 4 - Operation Queue (2 —á–∞—Å–∞)

**–ó–∞–¥–∞—á–∏:**

1. ‚¨ú –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `requestLayerOperation()`
2. ‚¨ú –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `processOperationQueue()`
3. ‚¨ú –°–¥–µ–ª–∞—Ç—å async: `centerLayerOnCameraAsync()`, `reloadLayerOnCameraShiftAsync()`
4. ‚¨ú –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `updateLayerManagement()`
5. ‚¨ú –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –ù–µ—Ç race conditions, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç

### –≠—Ç–∞–ø 6: –£—Ä–æ–≤–µ–Ω—å 5 - Debounce (1 —á–∞—Å)

**–ó–∞–¥–∞—á–∏:**

1. ‚¨ú –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `scheduleCenterOnStop()`
2. ‚¨ú –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `cancelCenterDebounce()`
3. ‚¨ú –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `updateLayerManagement()`
4. ‚¨ú –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ä–µ–∞–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

### –≠—Ç–∞–ø 7: –û—á–∏—Å—Ç–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (1-2 —á–∞—Å–∞)

**–ó–∞–¥–∞—á–∏:**

1. ‚¨ú –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –∏–∑ MainScene (`tilemapStreamingTimer`)
2. ‚¨ú –£–¥–∞–ª–∏—Ç—å `checkCameraPosition()` –∏–∑ TilemapController
3. ‚¨ú –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `destroy()`
4. ‚¨ú –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `getMetrics()`
5. ‚¨ú –ü—Ä–æ–≤–µ—Ä–∏—Ç—å linter errors

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –ö–æ–¥ —á–∏—Å—Ç—ã–π, –Ω–µ—Ç –º—ë—Ä—Ç–≤–æ–≥–æ –∫–æ–¥–∞

### –≠—Ç–∞–ø 8: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (2-3 —á–∞—Å–∞)

**–¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**

1. **–ü—Ä–æ—Å—Ç–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –≤–ø—Ä–∞–≤–æ**
   - –û–∂–∏–¥–∞–Ω–∏–µ: –°–æ–∑–¥–∞—ë—Ç—Å—è —Å–ª–æ–π —Å–ø—Ä–∞–≤–∞ –¥–æ –≤—ã—Ö–æ–¥–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—É

2. **–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã**
   - –û–∂–∏–¥–∞–Ω–∏–µ: –ß–µ—Ä–µ–∑ 600–º—Å —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ—è

3. **–î–≤–∏–∂–µ–Ω–∏–µ –≤–ª–µ–≤–æ ‚Üí –ø–æ–≤–æ—Ä–æ—Ç –≤–≤–µ—Ä—Ö**
   - –û–∂–∏–¥–∞–Ω–∏–µ: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–≤–µ—Ä—Ö

4. **–î–≤–∏–∂–µ–Ω–∏–µ –≤–¥–æ–ª—å –≥—Ä–∞–Ω–∏—Ü—ã**
   - –û–∂–∏–¥–∞–Ω–∏–µ: –ù–µ—Ç –ª–æ–∂–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∏–π —Å–ª–æ—ë–≤

5. **–ë—ã—Å—Ç—Ä–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ**
   - –û–∂–∏–¥–∞–Ω–∏–µ: –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π throttling, Fast Path —Ä–∞–±–æ—Ç–∞–µ—Ç

6. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**
   - –û–∂–∏–¥–∞–Ω–∏–µ: –û—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ

7. **–ö—Ä–∞—Ç–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞**
   - –û–∂–∏–¥–∞–Ω–∏–µ: –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ

### –≠—Ç–∞–ø 9: –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ (1-2 —á–∞—Å–∞)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**

1. ‚¨ú `BASE_SAFE_ZONE_RATIO` - —Ä–∞–∑–º–µ—Ä Safe Zone
2. ‚¨ú `VELOCITY_SMOOTHING` - –ø–ª–∞–≤–Ω–æ—Å—Ç—å —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
3. ‚¨ú `STOP_THRESHOLD` - –ø–æ—Ä–æ–≥ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
4. ‚¨ú `PREDICTION_TIME` - –≤—Ä–µ–º—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
5. ‚¨ú `AGGRESSIVE_THRESHOLD` - –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏
6. ‚¨ú `CENTER_DEBOUNCE_DELAY` - –∑–∞–¥–µ—Ä–∂–∫–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è

**–ú–µ—Ç–æ–¥:** –ò–≥—Ä–∞—Ç—å, –Ω–∞–±–ª—é–¥–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π gameplay, –º–∏–Ω–∏–º—É–º –ª–∏—à–Ω–∏—Ö —Å–æ–∑–¥–∞–Ω–∏–π —Å–ª–æ—ë–≤

### –≠—Ç–∞–ø 10: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –∫–æ–º–º–∏—Ç (30 –º–∏–Ω—É—Ç)

**–ó–∞–¥–∞—á–∏:**

1. ‚¨ú –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ
2. ‚¨ú –ü—Ä–æ–≤–µ—Ä–∏—Ç—å README (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
3. ‚¨ú –°–æ–∑–¥–∞—Ç—å –∫–æ–º–º–∏—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
4. ‚¨ú –û–±–Ω–æ–≤–∏—Ç—å STYLEGUIDE.md (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ code review

---

## –¢–∞–±–ª–∏—Ü–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

| –ü–∞—Ä–∞–º–µ—Ç—Ä                    | –ó–Ω–∞—á–µ–Ω–∏–µ | –ï–¥–∏–Ω–∏—Ü—ã | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ               | –ö–∞–∫ –≤–ª–∏—è–µ—Ç                     |
| --------------------------- | -------- | ------- | ------------------------ | ------------------------------ |
| `BASE_SAFE_ZONE_RATIO`      | 0.4      | –¥–æ–ª—è    | –ë–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä Safe Zone | ‚Üë = –±–æ–ª—å—à–µ –∑–æ–Ω–∞, —Ä–µ–∂–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ |
| `LOOKAHEAD_TIME`            | 200      | –º—Å      | –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ Safe Zone     | ‚Üë = —Ä–∞–Ω—å—à–µ –≤—ã—Ö–æ–¥ –∏–∑ –∑–æ–Ω—ã       |
| `VELOCITY_SMOOTHING`        | 0.7      | –∫–æ—ç—Ñ.   | –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏     | ‚Üë = –ø–ª–∞–≤–Ω–µ–µ, –º–µ–¥–ª–µ–Ω–Ω–µ–µ —Ä–µ–∞–∫—Ü–∏—è |
| `STOP_THRESHOLD`            | 0.5      | px/ms   | –ü–æ—Ä–æ–≥ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏          | ‚Üì = —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–µ–µ             |
| `MAX_SPEED`                 | 10       | px/ms   | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏     | –ó–∞—â–∏—Ç–∞ –æ—Ç –∞–Ω–æ–º–∞–ª–∏–π             |
| `PREDICTION_TIME`           | 300      | –º—Å      | –í—Ä–µ–º—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è       | ‚Üë = —Ä–∞–Ω—å—à–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—ë–≤      |
| `BASE_THRESHOLD`            | 0.33     | –¥–æ–ª—è    | –û–±—ã—á–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞          | ‚Üì = –ø–æ–∑–∂–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—ë–≤       |
| `AGGRESSIVE_THRESHOLD`      | 0.50     | –¥–æ–ª—è    | –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞      | ‚Üë = —Ä–∞–Ω—å—à–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—ë–≤      |
| `DIRECTION_DOMINANCE_RATIO` | 1.2      | –∫–æ—ç—Ñ.   | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–º–∏–Ω–∞–Ω—Ç—ã    | ‚Üë = —Å–ª–æ–∂–Ω–µ–µ –¥–∏–∞–≥–æ–Ω–∞–ª—å          |
| `MAX_QUEUE_SIZE`            | 3        | —à—Ç.     | –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏           | –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è         |
| `CENTER_DEBOUNCE_DELAY`     | 600      | –º—Å      | –ó–∞–¥–µ—Ä–∂–∫–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è   | ‚Üì = –±—ã—Å—Ç—Ä–µ–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ      |

---

## –ú–µ—Ç—Ä–∏–∫–∏ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

```typescript
const metrics = tilemapController.getMetrics();
console.log(metrics);
// {
//   totalOperations: 15,
//   movementOperations: 12,
//   centerOperations: 3,
//   failedOperations: 0,
//   queueOperations: 15,
//   lastOperationTime: 145, // –º—Å
//   fastPathHits: 4800,
// }
```

### –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ renderGrid() –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ Safe Zone
if (DEBUG_MODE) {
  const graphics = this.scene.add.graphics();
  graphics.lineStyle(2, 0x00ff00, 0.5);
  graphics.strokeRectShape(this.dynamicSafeZone);

  // –í–µ–∫—Ç–æ—Ä —Å–∫–æ—Ä–æ—Å—Ç–∏
  const { centerX, centerY } = camera;
  graphics.lineStyle(2, 0xff0000, 1);
  graphics.lineBetween(
    centerX,
    centerY,
    centerX + this.velocity.x * 100,
    centerY + this.velocity.y * 100
  );
}
```

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases

### 1. –¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã

```typescript
updateVelocityThrottled(): void {
  // ...
  const instantSpeed = Math.sqrt(instantVelocityX ** 2 + instantVelocityY ** 2);

  // –¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è (—Å–∫–æ—Ä–æ—Å—Ç—å > 20 px/ms)
  if (instantSpeed > 20) {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –∏ —É—Å–∫–æ—Ä–µ–Ω–∏–µ
    this.velocity = { x: 0, y: 0 };
    this.acceleration = { x: 0, y: 0 };

    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–ª–æ–π
    this.requestLayerOperation('center', undefined, 'teleport');
    return;
  }
  // ...
}
```

### 2. –û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π FPS

```typescript
updateVelocityThrottled(): void {
  // ...
  // –ï—Å–ª–∏ FPS < 20 (delta > 50–º—Å), —É–ø—Ä–æ—â–∞–µ–º —Å–∏—Å—Ç–µ–º—É
  if (deltaTime > 50) {
    // –û—Ç–∫–ª—é—á–∞–µ–º throttling, –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä
    this.frameCounter = 0;

    // –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
    this.usePrediction = false;
  } else {
    this.usePrediction = true;
  }
  // ...
}
```

### 3. NaN / Infinity

```typescript
// –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ updateVelocityThrottled():
if (!isFinite(centerX) || !isFinite(centerY)) return;
if (!isFinite(instantVelocityX) || !isFinite(instantVelocityY)) return;
```

---

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ "–¥–æ" –∏ "–ø–æ—Å–ª–µ"

### –ë—ã–ª–æ (—Ç–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)

```typescript
// MainScene.ts
this.tilemapStreamingTimer = this.time.addEvent({
  delay: this.tilemapController.getAvgTileGenTime(),
  callback: async () => {
    await this.tilemapController.reloadLayerOnCameraShift();
    // ...
  },
});

// TilemapController.ts
reloadLayerOnCameraShift() {
  const shift = this.checkCameraPosition();
  if (!shift) return;
  // ... —Å–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—è
}
```

**–ü—Ä–æ–±–ª–µ–º—ã:**

- ‚ùå –¢–∞–π–º–µ—Ä –Ω–µ –∑–Ω–∞–µ—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∫–∞–º–µ—Ä—ã
- ‚ùå –ù–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚ùå –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç race conditions
- ‚ùå –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ

### –°—Ç–∞–ª–æ (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è)

```typescript
// MainScene.ts
update(time, delta) {
  this.tilemapController.updateLayerManagement();
  // ...
}

// TilemapController.ts
updateLayerManagement() {
  // –£—Ä–æ–≤–µ–Ω—å 1: Fast Path
  if (this.isInSafeZone()) return;

  // –£—Ä–æ–≤–µ–Ω—å 2: Velocity
  this.updateVelocityThrottled();

  // –£—Ä–æ–≤–µ–Ω—å 3: Prediction
  if (this.isCameraStopped()) {
    this.scheduleCenterOnStop();
    return;
  }

  const prediction = this.shouldCreateNewLayer();
  if (prediction) {
    this.requestLayerOperation('movement', prediction.direction);
  }
}
```

**–†–µ—à–µ–Ω–æ:**

- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞–º–µ—Ä—ã
- ‚úÖ –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ —Å —É—á—ë—Ç–æ–º —É—Å–∫–æ—Ä–µ–Ω–∏—è
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è race conditions —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
- ‚úÖ –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## –°—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

- **TILEMAP_STRATEGY_0.md** - Spatial Culling + Target State
- **TILEMAP_STRATEGY_1.md** - –í–µ–∫—Ç–æ—Ä –¥–≤–∏–∂–µ–Ω–∏—è —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º–∏ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
- **TILEMAP_STRATEGY_2.md** - Velocity-Based Predictive Layer Management
- **REVIEW_1.md** - –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö —Ç—Ä—ë—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π

## –°—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

- `src/game/scenes/TilemapController.ts` - –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –¥–ª—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `src/game/scenes/MainScene.ts` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
- `src/game/constants.ts` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

–ü—Ä–∏ —Å–±–æ–µ IDE –∏–ª–∏ –ø–æ—Ç–µ—Ä–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:

1. ‚úÖ –ü—Ä–æ—á–∏—Ç–∞—Ç—å Executive Summary –≤ –Ω–∞—á–∞–ª–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
2. ‚úÖ –ò–∑—É—á–∏—Ç—å "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è" (–º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
3. ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å "–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã" (5 —É—Ä–æ–≤–Ω–µ–π)
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π —ç—Ç–∞–ø –≤ "–ü–ª–∞–Ω –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏"
5. ‚úÖ –°–≤–µ—Ä–∏—Ç—å –∫–æ–¥ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏–∑ "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞"
6. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
7. ‚úÖ –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö - —Å–≤–µ—Ä–∏—Ç—å —Å —Ä–∞–∑–¥–µ–ª–æ–º "–û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases"
8. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: `getMetrics()`

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –ª—É—á—à–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ç—Ä—ë—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç          | –ò—Å—Ç–æ—á–Ω–∏–∫       | –£–ª—É—á—à–µ–Ω–∏—è                 |
| ------------------ | -------------- | ------------------------- |
| Fast Path          | –°—Ç—Ä–∞—Ç–µ–≥–∏—è 0    | + –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ |
| Velocity Tracking  | –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2    | + Throttling, + –£—Å–∫–æ—Ä–µ–Ω–∏–µ |
| –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã | –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1    | + –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ            |
| Operation Queue    | –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2    | + –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞     |
| Debounce           | –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1, 2 | + Phaser Timer            |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è       | –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1    | + –ê–Ω–∞–ª–∏–∑ edge cases       |

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è, –Ω–∞–¥—ë–∂–Ω–∞—è –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ —Å–ª–æ—è–º–∏ —Ç–∞–π–ª–º–∞–ø–∞, –≥–æ—Ç–æ–≤–∞—è –∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é –∏ –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.

**–û—Ü–µ–Ω–∫–∞:** 9.2/10 ‚≠ê
